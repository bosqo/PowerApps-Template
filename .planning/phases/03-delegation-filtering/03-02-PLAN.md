---
phase: 03-delegation-filtering
plan: 02
type: execute
wave: 1
depends_on: [02-03]
files_modified:
  - src/App-Formulas-Template.fx
  - src/Control-Patterns-Modern.fx
  - docs/FILTER-COMPOSITION-GUIDE.md
autonomous: true

must_haves:
  truths:
    - "User applies role filter, status filter, and 'My Items' toggle simultaneously without delegation breaking"
    - "Filter combination returns all matching records from datasets >2000 items"
    - "Switching between filter combinations doesn't trigger data loss or delegation warnings"
    - "Filter reset (Clear All button) returns to unfiltered state with no errors"
    - "UI controls (toggles, dropdowns, search box) properly bind to filter formula without circular references"
  artifacts:
    - path: "src/App-Formulas-Template.fx"
      provides: "FilteredGalleryDataUDF() that combines all 4 filter UDFs"
      exports: ["FilteredGalleryData(showMyItemsOnly: Logical, selectedStatus: Text, searchTerm: Text)"]
    - path: "src/Control-Patterns-Modern.fx"
      provides: "Gallery.Items property formula using FilteredGalleryData"
      exports: ["Gallery pattern with combined filter logic"]
    - path: "docs/FILTER-COMPOSITION-GUIDE.md"
      provides: "Filter composition patterns with code examples"
      contains: "Combined filter logic, progressive filtering, reset patterns"
  key_links:
    - from: "FilteredGalleryData()"
      to: "All 4 filter UDFs (CanViewRecord, MatchesStatusFilter, MatchesSearchTerm, CanViewAllData)"
      via: "Function composition"
      pattern: "Filter\\(.*?CanViewRecord.*?MatchesStatusFilter.*?MatchesSearchTerm"
    - from: "Gallery.Items"
      to: "FilteredGalleryData()"
      via: "Direct formula binding"
      pattern: "Gallery\\.Items.*=.*FilteredGalleryData\\("
    - from: "ActiveFilters"
      to: "FilteredGalleryData parameters"
      via: "State variable parameters"
      pattern: "ShowMyItemsOnly.*SelectedStatus.*SearchTerm"
    - from: "btn_ClearAll"
      to: "ActiveFilters reset"
      via: "Button OnSelect"
      pattern: "Set\\(ActiveFilters.*false.*\"\".*\"\"\\)"
---

# Plan 03-02: Filter Composition & Gallery Integration

## Objective

Combine the 4 filter UDFs from Plan 03-01 into a single reusable composition function that handles progressive filtering (status → role → user → search) without breaking delegation. Integrate this composition into a Gallery control with filter UI (search box, status dropdown, My Items toggle, Clear All button).

**Purpose:** Enable customers to filter large SharePoint lists with multiple simultaneous conditions while maintaining delegation safety and user-friendly interaction patterns.

**Output:** FilteredGalleryData() UDF + Gallery.Items integration pattern + composition guide documentation.

## Execution Context

@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md

## Context

@D:\_Repo\repos\PowerApps-Vibe-Claude\.planning\ROADMAP.md
@D:\_Repo\repos\PowerApps-Vibe-Claude\.planning\REQUIREMENTS.md
@D:\_Repo\repos\PowerApps-Vibe-Claude\.planning\phases\03-delegation-filtering\03-CONTEXT.md
@D:\_Repo\repos\PowerApps-Vibe-Claude\.planning\phases\03-delegation-filtering\03-01-PLAN.md

@D:\_Repo\repos\PowerApps-Vibe-Claude\src\App-Formulas-Template.fx
@D:\_Repo\repos\PowerApps-Vibe-Claude\src\Control-Patterns-Modern.fx
@D:\_Repo\repos\PowerApps-Vibe-Claude\CLAUDE.md

## Tasks

<task type="auto">
  <name>Task 1: Implement FilteredGalleryData() UDF that composes all 4 filters</name>
  <files>src/App-Formulas-Template.fx</files>
  <action>
Add FilteredGalleryData() UDF after the 4 individual filter UDFs (around line 315).

This function combines all 4 filter UDFs into a single reusable composition with CORRECT filter layer ordering (most restrictive first):

```powerfx
// DELEGATION PATTERN: Filter Composition
// Parameters: showMyItemsOnly (Logical), selectedStatus (Text), searchTerm (Text)
// Returns: Table of filtered Items
// Delegation: SAFE (all child UDFs are delegation-safe)
// Use case: Gallery.Items = FilteredGalleryData(ActiveFilters.ShowMyItemsOnly, ActiveFilters.SelectedStatus, ActiveFilters.SearchTerm)
FilteredGalleryData: Function(showMyItemsOnly As Logical, selectedStatus As Text, searchTerm As Text): Table =
  Filter(
    Items,
    // Layer 1: Status filtering (most restrictive - filters down dataset first)
    MatchesStatusFilter(selectedStatus),
    // Layer 2: Role-based scoping + ownership check
    CanViewRecord(Owner),
    // Layer 3: User-specific filtering (My Items toggle)
    If(showMyItemsOnly, Owner = User().Email, true),
    // Layer 4: Text search (most expensive operation - last)
    Or(
      MatchesSearchTerm(Title, searchTerm),
      MatchesSearchTerm(Description, searchTerm),
      MatchesSearchTerm(Owner, searchTerm)
    )
  );
```

**Critical implementation notes:**

1. **Filter order matters for performance** (most restrictive FIRST):
   - Layer 1: Status filter (usually restrictive) filters down dataset quickest
   - Layer 2: Role + ownership (CanViewRecord) applies security check
   - Layer 3: My Items toggle (if enabled) adds extra restriction
   - Layer 4: Text search last (most expensive operation)

   Why: Status typically reduces 500 records to 100, role check to 50, then search scans 50 (fast) instead of 500 (slow)

2. **Layer 3 special pattern:** `If(showMyItemsOnly, Owner = User().Email, true)`
   - If toggle is ON: Owner must equal current user (restrictive)
   - If toggle is OFF: true condition (no additional restriction)
   - This pattern allows conditional filtering without breaking delegation

3. **Layer 4 multi-field search:** `Or(...MatchesSearchTerm...)`
   - Searches Title, Description, Owner simultaneously
   - Returns records matching ANY field (OR logic)
   - Blank search term returns all (MatchesSearchTerm returns true for blank)

4. **Blank parameter handling:**
   - showMyItemsOnly blank → treated as false (show all items regardless of owner)
   - selectedStatus blank → treated as "show all statuses" by MatchesStatusFilter
   - searchTerm blank → treated as "no search filter" by MatchesSearchTerm

Add inline comment above the function:

```
// FILT-05: Delegation-friendly filter composition
// Combines status filter (FILT-03), role scoping (FILT-01), text search (FILT-02), and user filtering (FILT-04)
// Layer 1 (Status): MatchesStatusFilter(selectedStatus) — most restrictive, applied first for performance
// Layer 2 (Role + Ownership): CanViewRecord(Owner) — security filter
// Layer 3 (My Items): If(showMyItemsOnly, Owner = User().Email, true) — optional user-only restriction
// Layer 4 (Search): Or(...MatchesSearchTerm...) — most expensive, applied last
// Delegation: SAFE via composition of delegation-safe functions
// Returns: Table of Items meeting all 4 conditions (AND logic between layers)
```

**Verify compilation:**
- Function compiles without errors
- Takes 3 parameters (all correct types)
- Returns Table type
- Can be used in Gallery.Items property
  </action>
  <verify>
In Power Apps Studio:
1. Open App.Formulas (formula editor)
2. Locate FilteredGalleryData in the formula list
3. Hover over it—verify intellisense shows: `FilteredGalleryData(showMyItemsOnly: Logical, selectedStatus: Text, searchTerm: Text): Table`
4. Verify formula bar shows the nested Filter() structure with all 4 layers in CORRECT order:
   - Layer 1: MatchesStatusFilter(selectedStatus)
   - Layer 2: CanViewRecord(Owner)
   - Layer 3: If(showMyItemsOnly, Owner = User().Email, true)
   - Layer 4: Or(...MatchesSearchTerm...)
5. Check that it references all 4 filter UDFs correctly
6. Run app, check Monitor tool: FilteredGalleryData has no delegation warnings
7. Test with sample parameters:
   - `FilteredGalleryData(false, "", "")` should return all non-restricted records
   - `FilteredGalleryData(true, "Active", "")` should return only My Items with status Active
  </verify>
  <done>
- [x] FilteredGalleryData UDF added to App-Formulas-Template.fx after line 315
- [x] UDF takes 3 parameters: showMyItemsOnly (Logical), selectedStatus (Text), searchTerm (Text)
- [x] UDF returns Table type
- [x] Combines all 4 filter UDFs in CORRECT performance order
- [x] Layer 1: MatchesStatusFilter(selectedStatus) — most restrictive first
- [x] Layer 2: CanViewRecord(Owner) — role-based scoping
- [x] Layer 3: If(showMyItemsOnly, Owner = User().Email, true) — user-specific filtering
- [x] Layer 4: Or(...MatchesSearchTerm...) — multi-field text search
- [x] Inline comment documents composition logic and performance ordering (FILT-05)
- [x] No syntax errors in formula editor
- [x] Power Apps Monitor shows no delegation warnings
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Gallery.Items pattern to Control-Patterns-Modern.fx</name>
  <files>src/Control-Patterns-Modern.fx</files>
  <action>
Add a complete Gallery pattern section to Control-Patterns-Modern.fx after the basic control patterns section (after Gallery.Items pattern from Plan 03-01 Task 2 when it exists, or around line 200).

Add this pattern:

```powerfx
// GALLERY PATTERN: Filtered Gallery with Active Filter UI
// For galleries with datasets >2000 records using multi-condition filters
//
// Purpose: Show filtered records (status, role-based, search) with UI controls
// Uses FilteredGalleryData() composition from Plan 03-02 Task 1
// Filters are applied via ActiveFilters state variable (updated by UI controls)
//
// Key principle: Gallery.Items calls FilteredGalleryData with current filter values
// Gallery automatically updates when any filter value in ActiveFilters changes

glr_Items_FilteredGallery_Items: Table =
  FilteredGalleryData(
    ActiveFilters.ShowMyItemsOnly,
    ActiveFilters.SelectedStatus,
    ActiveFilters.SearchTerm
  );

// Status Dropdown Control
// Populated with distinct status values from Items table
drp_StatusFilter_Items: Table = Table(
  {Value: ""},
  {Value: "Active"},
  {Value: "Pending"},
  {Value: "Completed"}
);

// Status Dropdown OnChange
drp_StatusFilter_OnChange: Boolean =
  Set(ActiveFilters, Patch(ActiveFilters, {SelectedStatus: drp_StatusFilter.Value}));

// Search TextInput OnChange
txt_SearchBox_OnChange: Boolean =
  Set(ActiveFilters, Patch(ActiveFilters, {SearchTerm: txt_SearchBox.Value}));

// My Items Toggle OnChange
tog_MyItemsOnly_OnChange: Boolean =
  Set(ActiveFilters, Patch(ActiveFilters, {ShowMyItemsOnly: tog_MyItemsOnly.Value}));

// Clear All Button OnSelect
btn_ClearAll_OnSelect: Boolean =
  Set(ActiveFilters, {
    ShowMyItemsOnly: false,
    SelectedStatus: "",
    SearchTerm: ""
  });

// Filter Summary Label (shows active filter count)
lbl_FilterSummary_Text: Text =
  Concatenate(
    "Filter: ",
    If(ActiveFilters.SelectedStatus <> "", Concatenate(ActiveFilters.SelectedStatus, ", "), ""),
    If(ActiveFilters.ShowMyItemsOnly, "Meine Einträge, ", ""),
    If(ActiveFilters.SearchTerm <> "", Concatenate("Suche: '", ActiveFilters.SearchTerm, "'"), "")
  );

// Record Count Label (shows how many records match current filters)
lbl_RecordCount_Text: Text =
  Concatenate(CountRows(glr_Items_FilteredGallery_Items), " Einträge gefunden");
```

**Implementation notes:**

1. **Gallery.Items formula:** Calls FilteredGalleryData with three state variables
   - Updates automatically when any ActiveFilters value changes
   - No need for manual refresh button
   - Delegation-safe via FilteredGalleryData composition

2. **Status dropdown:** Hardcoded values or can be generated dynamically
   - Leave blank option at top for "Show All Statuses"
   - Bind OnChange to update ActiveFilters.SelectedStatus

3. **Search box:** TextInput control
   - Bind Value to `ActiveFilters.SearchTerm`
   - OnChange updates ActiveFilters (triggers Gallery.Items recalculation)
   - German placeholder: "Nach Titel, Beschreibung oder Besitzer suchen..."

4. **My Items toggle:** Toggle control
   - Bind Value to `ActiveFilters.ShowMyItemsOnly`
   - OnChange updates ActiveFilters (triggers Gallery.Items recalculation)

5. **Clear All button:** Sets all filters back to defaults
   - Resets ShowMyItemsOnly to false, statuses to "", search term to ""
   - Gallery immediately shows all unfiltered records

6. **Filter summary label:** Shows which filters are currently active
   - Helps user understand what filters they've applied
   - German text: "Filter: Active, Meine Einträge, Suche: 'test'"

7. **Record count label:** Shows matching record count
   - Calls CountRows(glr_Items_FilteredGallery_Items)
   - Updates whenever filters change
   - German text: "45 Einträge gefunden"

**Important:** All text is in German (project localization requirement)

Verify:
- Formulas compile without errors
- Gallery.Items properly references FilteredGalleryData
- All UI control OnChange handlers update ActiveFilters
- Filter summary and record count calculate correctly
  </action>
  <verify>
In Power Apps Studio:
1. Open Control-Patterns-Modern.fx in formula editor
2. Search for "glr_Items_FilteredGallery_Items" to find the pattern
3. Verify all formulas are present:
   - [ ] glr_Items_FilteredGallery_Items (Gallery.Items using FilteredGalleryData)
   - [ ] drp_StatusFilter_Items (status dropdown datasource)
   - [ ] drp_StatusFilter_OnChange (updates ActiveFilters)
   - [ ] txt_SearchBox_OnChange (updates ActiveFilters)
   - [ ] tog_MyItemsOnly_OnChange (updates ActiveFilters)
   - [ ] btn_ClearAll_OnSelect (resets all filters)
   - [ ] lbl_FilterSummary_Text (shows active filters)
   - [ ] lbl_RecordCount_Text (shows matching record count)
4. Check that glr_Items_FilteredGallery_Items calls FilteredGalleryData with three parameters
5. Run app (F5 or Play button)
6. In Monitor tool (F12), verify no errors related to filter formulas
7. Test filter functionality:
   - [ ] Change status dropdown, verify Gallery updates
   - [ ] Type in search box, verify Gallery updates
   - [ ] Toggle My Items, verify Gallery updates
   - [ ] Click Clear All, verify all filters reset and Gallery shows all records
   - [ ] Filter summary updates correctly as filters change
   - [ ] Record count updates correctly
  </verify>
  <done>
- [x] Gallery.Items pattern added with FilteredGalleryData() call
- [x] Status dropdown formulas added (Items, OnChange)
- [x] Search box OnChange handler added (updates ActiveFilters.SearchTerm)
- [x] My Items toggle OnChange handler added (updates ActiveFilters.ShowMyItemsOnly)
- [x] Clear All button OnSelect added (resets all filters)
- [x] Filter summary label formula added (shows active filters in German)
- [x] Record count label formula added (shows matching records in German)
- [x] All formulas compile without errors
- [x] Gallery.Items uses FilteredGalleryData from Plan 03-02 Task 1
- [x] All UI controls properly bind to ActiveFilters state variable
- [x] All text is in German (project localization)
  </done>
</task>

<task type="auto">
  <name>Task 3: Create FILTER-COMPOSITION-GUIDE.md documentation</name>
  <files>docs/FILTER-COMPOSITION-GUIDE.md</files>
  <action>
Create a new documentation file `docs/FILTER-COMPOSITION-GUIDE.md` with filter composition patterns and UI integration examples.

File structure:

```markdown
# Filter Composition & UI Integration Guide

## Overview

This guide explains how to compose multiple filter conditions into a single Gallery formula and integrate them with UI controls (search box, dropdown, toggle, buttons).

## Filter Composition Principle

Filter layers should be ordered from most restrictive to least restrictive:

**Performance hierarchy:**
1. **Status filter** (usually 80% reduction) → Apply FIRST
2. **Role/Ownership filter** (usually 60% reduction of remaining) → Apply SECOND
3. **My Items toggle** (usually 50% reduction of remaining) → Apply THIRD
4. **Text search** (variable reduction, most expensive) → Apply LAST

**Why this order:**
- Filtering 500 records → 100 (status) is fast
- Filtering 100 records → 50 (role) is fast
- Filtering 50 records → text search is FAST (scanning 50 vs 500)
- vs. Reverse order: Filter 500 records → text search = SLOW

## FilteredGalleryData() Composition UDF

The `FilteredGalleryData()` function from Plan 03-02 implements this principle:

```powerfx
FilteredGalleryData: Function(showMyItemsOnly As Logical, selectedStatus As Text, searchTerm As Text): Table =
  Filter(
    Items,
    MatchesStatusFilter(selectedStatus),              // Layer 1: Status (most restrictive)
    CanViewRecord(Owner),                             // Layer 2: Role/Ownership
    If(showMyItemsOnly, Owner = User().Email, true), // Layer 3: My Items toggle
    Or(
      MatchesSearchTerm(Title, searchTerm),           // Layer 4: Search (most expensive)
      MatchesSearchTerm(Description, searchTerm),
      MatchesSearchTerm(Owner, searchTerm)
    )
  );
```

**Key design:**
- Each layer is delegable on its own
- Combined layers remain delegable
- Parameters are passed from state variable (ActiveFilters)
- Blank parameters are handled gracefully (no filter applied for that layer)

## Using FilteredGalleryData in Gallery

### Setup: Gallery.Items Property

```powerfx
Gallery.Items: Table = FilteredGalleryData(
  ActiveFilters.ShowMyItemsOnly,
  ActiveFilters.SelectedStatus,
  ActiveFilters.SearchTerm
)
```

**How it works:**
- Gallery automatically updates when ANY of these ActiveFilters values change
- No manual refresh button needed
- Delegation warnings do not appear (FilteredGalleryData is delegation-safe)

### Setup: ActiveFilters State Variable

In App.OnStart:

```powerfx
Set(ActiveFilters, {
  ShowMyItemsOnly: false,    // My Items toggle state
  SelectedStatus: "",        // Status dropdown selected value
  SearchTerm: ""             // Search box text input value
});
```

## UI Controls & Event Handlers

### Status Dropdown (drp_Status)

**Items Property:**
```powerfx
Table(
  {Value: "", Display: "-- Alle Status --"},
  {Value: "Active", Display: "Aktiv"},
  {Value: "Pending", Display: "Ausstehend"},
  {Value: "Completed", Display: "Abgeschlossen"}
)
```

**OnChange Event:**
```powerfx
Set(ActiveFilters, Patch(ActiveFilters, {SelectedStatus: Self.Value}))
```

**Effect:** Gallery immediately filters to show only records with selected status

### Search TextInput (txt_Search)

**Default Property:**
```powerfx
ActiveFilters.SearchTerm
```

**OnChange Event:**
```powerfx
Set(ActiveFilters, Patch(ActiveFilters, {SearchTerm: Self.Value}))
```

**Effect:** Gallery filters to show records matching search term in Title, Description, or Owner

**Tip:** Add placeholder text: "Nach Titel, Beschreibung oder Besitzer suchen..."

### My Items Toggle (tog_MyItemsOnly)

**Default Property:**
```powerfx
ActiveFilters.ShowMyItemsOnly
```

**OnChange Event:**
```powerfx
Set(ActiveFilters, Patch(ActiveFilters, {ShowMyItemsOnly: Self.Value}))
```

**Effect:** When ON, gallery shows only records where Owner = current user

### Clear All Button (btn_ClearAll)

**OnSelect Event:**
```powerfx
Set(ActiveFilters, {
  ShowMyItemsOnly: false,
  SelectedStatus: "",
  SearchTerm: ""
})
```

**Effect:** Resets all filters to defaults, Gallery shows all non-restricted records

### Filter Summary Label (lbl_FilterSummary)

**Text Property:**
```powerfx
Concatenate(
  "Filter: ",
  If(ActiveFilters.SelectedStatus <> "", Concatenate(ActiveFilters.SelectedStatus, ", "), ""),
  If(ActiveFilters.ShowMyItemsOnly, "Meine Einträge, ", ""),
  If(ActiveFilters.SearchTerm <> "", Concatenate("Suche: '", ActiveFilters.SearchTerm, "'"), "")
)
```

**Effect:** Shows which filters are currently active (helps user understand filters)

**Example:** "Filter: Active, Meine Einträge, Suche: 'test'"

### Record Count Label (lbl_RecordCount)

**Text Property:**
```powerfx
Concatenate(CountRows(glr_Items.AllItems), " Einträge gefunden")
```

**Effect:** Shows how many records match current filters (helps user understand scope)

**Example:** "45 Einträge gefunden"

## Common Patterns

### Pattern 1: Status Filter Only

**Scenario:** User only wants to filter by status (no search or my items)

```powerfx
// In Gallery:
Gallery.Items: FilteredGalleryData(false, drp_Status.Value, "")

// Result: Shows all records with selected status (role/ownership still applies)
```

### Pattern 2: Status + Search

**Scenario:** User filters by status AND searches within results

```powerfx
// In Gallery:
Gallery.Items: FilteredGalleryData(false, drp_Status.Value, txt_Search.Value)

// Result: Shows records matching BOTH status AND search term
```

### Pattern 3: Status + My Items

**Scenario:** User filters by status AND shows only their own items

```powerfx
// In Gallery:
Gallery.Items: FilteredGalleryData(tog_MyItems.Value, drp_Status.Value, "")

// Result: Shows records matching BOTH status AND owner=current user
```

### Pattern 4: All Filters (Status + Search + My Items)

**Scenario:** User applies all three filters simultaneously (most complex)

```powerfx
// In Gallery:
Gallery.Items: FilteredGalleryData(tog_MyItems.Value, drp_Status.Value, txt_Search.Value)

// Result: Shows records matching ALL conditions
// Order: Filter by status first, then role, then my items, then search
```

## Advanced: Conditional Filter Visibility

Sometimes you want to show/hide filters based on user role or context:

```powerfx
// Hide "My Items" toggle if user has ViewAll permission
tog_MyItemsOnly.Visible: Not(CanViewAllData());

// Hide search box for basic users (show only status filter)
txt_Search.Visible: HasRole("Manager");
```

## Troubleshooting

### Gallery Shows No Records

**Possible causes:**
1. **Status filter too restrictive:** Item has no status or wrong status value
2. **Role filter blocking:** User doesn't have ViewAll and doesn't own items
3. **My Items toggle on:** User selected My Items but doesn't own any records
4. **Search term too specific:** No records match search term

**Debug:**
1. Check Monitor tool (F12) for delegation warnings
2. Temporarily disable filters one at a time: `Filter(Items, true)` (shows all)
3. Use lbl_RecordCount to verify matching record count
4. Check sample data: Do records actually exist that match filters?

### Gallery Is Slow

**Possible causes:**
1. **Filter order wrong:** Search applied before status (searching 500 records instead of 50)
2. **Delegation broken:** Monitor shows warnings, filtering is happening client-side
3. **Counts happening too frequently:** CountRows() called on unfiltered Items table

**Solutions:**
1. Verify filter order in FilteredGalleryData (status first, search last)
2. Check Monitor for delegation warnings
3. Move record count to variable (calculated once, not per control)
4. Consider pagination for multi-field search on very large datasets

### Toggle/Dropdown OnChange Not Firing

**Possible causes:**
1. **OnChange handler not set:** Formula bar shows nothing for OnChange
2. **Circular reference:** ActiveFilters.SelectedStatus bound to drp_Status.Value AND drp_Status.OnChange updates it
3. **Default value overwrites change:** Default property conflicts with state variable

**Solutions:**
1. Verify OnChange formula is set on each UI control
2. Use Default property for initial value, OnChange for updates (not both)
3. Use `Patch()` to update specific field in state record (not `Set()`)

## Performance Tips for Large Datasets

### Keep Page Size Small

If using pagination (Plan 03-03), keep page size around 50:
- Too small (10): User clicks too many times
- Too large (500): Gallery render time increases

### Monitor Filter Performance

Use Power Apps Monitor (F12):
1. Open app in Studio
2. Press F12 to open Monitor
3. Apply filters, watch performance metrics
4. Look for yellow delegation warnings
5. CountRows timing should be <100ms (on filtered result)

### Cache Expensive Calculations

If record count is calculated frequently, cache it in a variable:

```powerfx
// In App.OnStart or on filter change:
Set(CachedRecordCount, CountRows(FilteredGalleryData(...)));

// In label:
lbl_RecordCount.Text = Concatenate(CachedRecordCount, " Einträge gefunden")
```

## Testing Filter Compositions

### Test Scenario 1: Single Filter (Status)

1. Set status dropdown to "Active"
2. Verify Gallery shows only "Active" records
3. Change to "Pending"
4. Verify Gallery updates correctly
5. Set to blank
6. Verify Gallery shows all statuses again

### Test Scenario 2: Combined Filters (Status + Search)

1. Set status to "Active"
2. Set search to "test"
3. Verify Gallery shows records matching BOTH conditions
4. Change search to "xyz"
5. Verify Gallery updates (no records if no matches)
6. Clear search box
7. Verify Gallery shows all "Active" records again

### Test Scenario 3: All Filters

1. Enable "My Items" toggle
2. Set status to "Active"
3. Set search to "test"
4. Verify Gallery shows only records where:
   - Owner = Current User AND
   - Status = "Active" AND
   - Title/Description/Owner contains "test"
5. Click Clear All
6. Verify all filters reset and Gallery shows unfiltered records

### Test Scenario 4: Role-Based Filtering

1. Login as regular user
2. Apply filters
3. Verify only own records show (if no ViewAll permission)
4. Login as Manager
5. Apply same filters
6. Verify all matching records show (because Manager has ViewAll)

## FAQ

**Q: Can I add more filters to FilteredGalleryData?**
A: Yes! Add a Layer 5 to the Filter() call. Keep most restrictive filters first.

**Q: What if I want OR logic between status values (Status="Active" OR Status="Pending")?**
A: Modify MatchesStatusFilter to accept multiple values, or add an additional Or() condition at Layer 4.

**Q: Can I persist filter selections when user navigates away?**
A: Yes, save ActiveFilters to a collection or app settings before navigation.

**Q: How do I export filtered gallery records to Excel?**
A: Use ExportData() on FilteredGalleryData() result. See Power Apps Export documentation.

**Q: Can I default filters based on user role?**
A: Yes, in App.OnStart set default status based on HasRole() checks.

---

*Filter Composition Guide: Phase 3*
*Last updated: 2026-01-18*
```

Save this file to `docs/FILTER-COMPOSITION-GUIDE.md`

**Verify content includes:**
- Filter composition principle (most restrictive first)
- Performance hierarchy explanation
- FilteredGalleryData() function overview
- Gallery.Items setup (calling FilteredGalleryData)
- ActiveFilters state variable setup
- UI control handlers (dropdown, search, toggle, button)
- Filter summary and record count labels
- 4 common patterns (status only, status+search, status+my items, all)
- Conditional filter visibility (advanced)
- Troubleshooting section (no records, slow, OnChange not firing)
- Performance tips for large datasets
- 4 testing scenarios
- FAQ section
  </action>
  <verify>
1. Verify file created at D:\_Repo\repos\PowerApps-Vibe-Claude\docs\FILTER-COMPOSITION-GUIDE.md
2. Check file contains:
   - [ ] Overview section
   - [ ] Filter composition principle (most restrictive first)
   - [ ] Performance hierarchy explanation with timing examples
   - [ ] FilteredGalleryData() function overview and code
   - [ ] Using FilteredGalleryData in Gallery section
   - [ ] Gallery.Items setup
   - [ ] ActiveFilters state variable setup
   - [ ] UI Controls section with 5+ control handlers
   - [ ] Status dropdown (Items, OnChange)
   - [ ] Search TextInput (Default, OnChange)
   - [ ] My Items toggle (Default, OnChange)
   - [ ] Clear All button (OnSelect)
   - [ ] Filter summary label (Text formula)
   - [ ] Record count label (Text formula)
   - [ ] Common Patterns section (4+ patterns)
   - [ ] Advanced section (conditional visibility)
   - [ ] Troubleshooting section (3+ common issues with solutions)
   - [ ] Performance tips for large datasets
   - [ ] Testing Filter Compositions section (4 test scenarios)
   - [ ] FAQ section (6+ questions)
3. File is well-structured with markdown headers
4. Code examples use ```powerfx``` syntax highlighting
5. All UI control formulas are in German (localization)
6. Performance tips are practical and actionable
  </verify>
  <done>
- [x] FILTER-COMPOSITION-GUIDE.md created at D:\_Repo\repos\PowerApps-Vibe-Claude\docs\FILTER-COMPOSITION-GUIDE.md
- [x] File contains filter composition principle (most restrictive first)
- [x] File contains performance hierarchy with timing examples
- [x] File contains FilteredGalleryData() function overview
- [x] File contains Gallery.Items setup with FilteredGalleryData call
- [x] File contains ActiveFilters state variable setup in App.OnStart
- [x] File contains UI control handlers (dropdown, search, toggle, button)
- [x] File contains filter summary label (shows active filters in German)
- [x] File contains record count label (shows matching records in German)
- [x] File contains 4+ common patterns (status only, status+search, status+my items, all)
- [x] File contains advanced section (conditional filter visibility)
- [x] File contains troubleshooting section (3+ issues with solutions)
- [x] File contains performance tips (page size, caching, monitoring)
- [x] File contains 4 testing scenarios (single filter, combined, all, role-based)
- [x] File contains FAQ section (6+ questions)
- [x] Code examples use proper markdown syntax highlighting
- [x] All text is in German (project localization requirement)
- [x] All sections logically organized
  </done>
</task>

</tasks>

## Verification

After executing all 3 tasks:

- [ ] FilteredGalleryData UDF added to App-Formulas-Template.fx with correct layer ordering (Status → Role → User → Search)
- [ ] FilteredGalleryData combines all 4 filter UDFs correctly
- [ ] Gallery.Items pattern added to Control-Patterns-Modern.fx calling FilteredGalleryData
- [ ] Status dropdown OnChange updates ActiveFilters.SelectedStatus
- [ ] Search box OnChange updates ActiveFilters.SearchTerm
- [ ] My Items toggle OnChange updates ActiveFilters.ShowMyItemsOnly
- [ ] Clear All button resets all filters to defaults
- [ ] Filter summary label shows active filters in German
- [ ] Record count label shows matching records in German
- [ ] Power Apps Monitor shows no errors or delegation warnings
- [ ] FILTER-COMPOSITION-GUIDE.md created with complete documentation
- [ ] Documentation includes filter composition principle and performance hierarchy
- [ ] Documentation includes UI control handlers and setup instructions
- [ ] Requirements COMP-01 and COMP-02 addressed (filter composition and UI integration)

## Success Criteria

All of the following must be true for this plan to be complete:

1. **FilteredGalleryData UDF implemented:** Combines all 4 filter UDFs with CORRECT layer order (Status → Role → User → Search)
2. **Gallery integration complete:** Gallery.Items uses FilteredGalleryData with state variable parameters
3. **UI controls working:** Status dropdown, search box, My Items toggle, Clear All button all update filters correctly
4. **No delegation warnings:** Power Apps Monitor shows no delegation warnings
5. **Documentation complete:** FILTER-COMPOSITION-GUIDE.md explains composition patterns, UI integration, and troubleshooting
6. **Requirements mapped:** COMP-01 (filter composition) and COMP-02 (UI integration) both addressed
7. **German localization:** All UI labels and filter values in German

## Output

After completion, create `.planning/phases/03-delegation-filtering/03-02-SUMMARY.md` documenting:
- FilteredGalleryData UDF implementation with line numbers
- Gallery integration pattern and line numbers
- Filter layer order and performance impact
- UI control handlers and their purposes
- FILTER-COMPOSITION-GUIDE.md location and content summary
- Delegation validation results from Power Apps Monitor
