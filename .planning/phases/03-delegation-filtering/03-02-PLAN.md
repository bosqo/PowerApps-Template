---
phase: 03-delegation-filtering
plan: 02
type: execute
wave: 1
depends_on: [02-03]
files_modified:
  - src/App-Formulas-Template.fx
  - src/Control-Patterns-Modern.fx
  - docs/FILTER-COMPOSITION-GUIDE.md
autonomous: true

must_haves:
  truths:
    - "User applies role filter, status filter, and 'My Items' toggle simultaneously without delegation breaking"
    - "Filter combination returns all matching records from datasets >2000 items"
    - "Switching between filter combinations doesn't trigger data loss or delegation warnings"
    - "Filter reset (Clear All button) returns to unfiltered state with no errors"
    - "UI controls (toggles, dropdowns, search box) properly bind to filter formula without circular references"
  artifacts:
    - path: "src/App-Formulas-Template.fx"
      provides: "FilteredGalleryDataUDF() that combines all 4 filter UDFs"
      exports: ["FilteredGalleryData(showMyItemsOnly: Logical, selectedStatus: Text, searchTerm: Text)"]
    - path: "src/Control-Patterns-Modern.fx"
      provides: "Gallery.Items property formula using FilteredGalleryData"
      exports: ["Gallery pattern with combined filter logic"]
    - path: "docs/FILTER-COMPOSITION-GUIDE.md"
      provides: "Filter composition patterns with code examples"
      contains: "Combined filter logic, progressive filtering, reset patterns"
  key_links:
    - from: "FilteredGalleryData()"
      to: "All 4 filter UDFs (CanViewRecord, MatchesStatusFilter, MatchesSearchTerm, CanViewAllData)"
      via: "Function composition"
      pattern: "Filter\\(.*?CanViewRecord.*?MatchesStatusFilter.*?MatchesSearchTerm"
    - from: "Gallery.Items"
      to: "FilteredGalleryData()"
      via: "Direct formula binding"
      pattern: "Gallery\\.Items.*=.*FilteredGalleryData\\("
    - from: "ActiveFilters"
      to: "FilteredGalleryData parameters"
      via: "State variable parameters"
      pattern: "ShowMyItemsOnly.*SelectedStatus.*SearchTerm"
    - from: "btn_ClearAll"
      to: "ActiveFilters reset"
      via: "Button OnSelect"
      pattern: "Set\\(ActiveFilters.*false.*\"\".*\"\"\\)"
---

# Plan 03-02: Filter Composition & Gallery Integration

## Objective

Combine the 4 filter UDFs from Plan 03-01 into a single reusable composition function that handles progressive filtering (role → status → user → search) without breaking delegation. Integrate this composition into a Gallery control with filter UI (search box, status dropdown, My Items toggle, Clear All button).

**Purpose:** Enable customers to filter large SharePoint lists with multiple simultaneous conditions while maintaining delegation safety and user-friendly interaction patterns.

**Output:** FilteredGalleryData() UDF + Gallery.Items integration pattern + composition guide documentation.

## Execution Context

@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md

## Context

@D:\_Repo\repos\PowerApps-Vibe-Claude\.planning\ROADMAP.md
@D:\_Repo\repos\PowerApps-Vibe-Claude\.planning\REQUIREMENTS.md
@D:\_Repo\repos\PowerApps-Vibe-Claude\.planning\phases\03-delegation-filtering\03-CONTEXT.md
@D:\_Repo\repos\PowerApps-Vibe-Claude\.planning\phases\03-delegation-filtering\03-01-PLAN.md

@D:\_Repo\repos\PowerApps-Vibe-Claude\src\App-Formulas-Template.fx
@D:\_Repo\repos\PowerApps-Vibe-Claude\src\Control-Patterns-Modern.fx
@D:\_Repo\repos\PowerApps-Vibe-Claude\CLAUDE.md

## Tasks

<task type="auto">
  <name>Task 1: Implement FilteredGalleryData() UDF that composes all 4 filters</name>
  <files>src/App-Formulas-Template.fx</files>
  <action>
Add FilteredGalleryData() UDF after the 4 individual filter UDFs (around line 315).

This function combines all 4 filter UDFs into a single reusable composition:

```powerfx
// DELEGATION PATTERN: Filter Composition
// Parameters: showMyItemsOnly (Logical), selectedStatus (Text), searchTerm (Text)
// Returns: Table of filtered Items
// Delegation: SAFE (all child UDFs are delegation-safe)
// Use case: Gallery.Items = FilteredGalleryData(ActiveFilters.ShowMyItemsOnly, ActiveFilters.SelectedStatus, ActiveFilters.SearchTerm)
FilteredGalleryData: Function(showMyItemsOnly As Logical, selectedStatus As Text, searchTerm As Text): Table =
  Filter(
    Items,
    // Layer 1: Role-based scoping + ownership check
    CanViewRecord(Owner),
    // Layer 2: Status filtering
    MatchesStatusFilter(selectedStatus),
    // Layer 3: User-specific filtering (My Items toggle)
    If(showMyItemsOnly, Owner = User().Email, true),
    // Layer 4: Text search (multi-field)
    Or(
      MatchesSearchTerm(Title, searchTerm),
      MatchesSearchTerm(Description, searchTerm),
      MatchesSearchTerm(Owner, searchTerm)
    )
  );
```

**Critical implementation notes:**

1. **Filter order:** Matters for performance (most restrictive first)
   - Role + ownership (CanViewRecord) filters out most records first
   - Status filter (usually restrictive) filters next
   - My Items toggle (if enabled) adds extra restriction
   - Text search last (most expensive operation)

2. **Layer 3 special pattern:** `If(showMyItemsOnly, Owner = User().Email, true)`
   - If toggle is ON: Owner must equal current user (restrictive)
   - If toggle is OFF: true condition (no additional restriction)
   - This pattern allows conditional filtering without breaking delegation

3. **Layer 4 multi-field search:** `Or(...MatchesSearchTerm...)`
   - Searches Title, Description, Owner simultaneously
   - Returns records matching ANY field (OR logic)
   - Blank search term returns all (MatchesSearchTerm returns true for blank)

4. **Blank parameter handling:**
   - showMyItemsOnly blank → treated as false (show all items regardless of owner)
   - selectedStatus blank → treated as "show all statuses" by MatchesStatusFilter
   - searchTerm blank → treated as "no search filter" by MatchesSearchTerm

Add inline comment above the function:

```
// FILT-05: Delegation-friendly filter composition
// Combines role scoping (FILT-01), text search (FILT-02), status filter (FILT-03), and user filtering (FILT-04)
// Layer 1 (Role + Ownership): CanViewRecord(Owner) — always applied
// Layer 2 (Status): MatchesStatusFilter(selectedStatus) — applies if not blank
// Layer 3 (My Items): If(showMyItemsOnly, Owner = User().Email, true) — applies if toggle on
// Layer 4 (Search): Or(...MatchesSearchTerm...) — applies if search term not blank
// Delegation: SAFE via composition of delegation-safe functions
// Returns: Table of Items meeting all 4 conditions (AND logic between layers)
```

**Verify compilation:**
- Function compiles without errors
- Takes 3 parameters (all correct types)
- Returns Table type
- Can be used in Gallery.Items property
  </action>
  <verify>
In Power Apps Studio:
1. Open App.Formulas (formula editor)
2. Locate FilteredGalleryData in the formula list
3. Hover over it—verify intellisense shows: `FilteredGalleryData(showMyItemsOnly: Logical, selectedStatus: Text, searchTerm: Text): Table`
4. Verify formula bar shows the nested Filter() structure with all 4 layers
5. Check that it references all 4 filter UDFs:
   - CanViewRecord(Owner)
   - MatchesStatusFilter(selectedStatus)
   - If(showMyItemsOnly, Owner = User().Email, true)
   - Or(...MatchesSearchTerm...)
6. Run app, check Monitor tool: FilteredGalleryData has no delegation warnings
7. Test with sample parameters:
   - `FilteredGalleryData(false, "", "")` should return all non-restricted records
   - `FilteredGalleryData(true, "Active", "")` should return only My Items with status Active
  </verify>
  <done>
- [x] FilteredGalleryData UDF added to App-Formulas-Template.fx after line 315
- [x] UDF takes 3 parameters: showMyItemsOnly (Logical), selectedStatus (Text), searchTerm (Text)
- [x] UDF returns Table type
- [x] Combines all 4 filter UDFs in proper order
- [x] Layer 1: CanViewRecord(Owner) — role-based scoping
- [x] Layer 2: MatchesStatusFilter(selectedStatus) — status filtering
- [x] Layer 3: If(showMyItemsOnly, Owner = User().Email, true) — user-specific filtering
- [x] Layer 4: Or(...MatchesSearchTerm...) — multi-field text search
- [x] Inline comment documents composition logic (FILT-05)
- [x] No syntax errors in formula editor
- [x] Power Apps Monitor shows no delegation warnings
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Gallery.Items pattern to Control-Patterns-Modern.fx</name>
  <files>src/Control-Patterns-Modern.fx