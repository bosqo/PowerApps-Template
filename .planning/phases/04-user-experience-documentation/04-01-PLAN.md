---
phase: 04-user-experience-documentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/App-Formulas-Template.fx
  - src/App-OnStart-Minimal.fx
autonomous: true

must_haves:
  truths:
    - "NotifySuccess/NotifyError/NotifyWarning/NotifyInfo UDFs exist and call AddToast internally"
    - "NotificationStack collection initializes in App.OnStart and persists across interactions"
    - "Notifications appear in application without requiring developer to hook up UI"
    - "Error notifications do NOT auto-dismiss; info/success/warning auto-dismiss after 5 seconds"
    - "Multiple toasts can be added simultaneously without overwriting or losing earlier toasts"
  artifacts:
    - path: "src/App-Formulas-Template.fx"
      provides: "Toast configuration, color/icon/duration UDFs, AddToast/RemoveToast helpers"
      min_lines: 200
    - path: "src/App-OnStart-Minimal.fx"
      provides: "NotificationStack collection initialization and toast counter"
      min_lines: 50
  key_links:
    - from: "NotifySuccess/NotifyError/NotifyWarning/NotifyInfo UDFs"
      to: "AddToast UDF"
      via: "internal call in UDF body"
      pattern: "AddToast\\(message.*Type.*Duration\\)"
    - from: "AddToast UDF"
      to: "NotificationStack collection"
      via: "Patch() to add row"
      pattern: "Patch\\(NotificationStack.*{ID:.*Message:.*Type"
    - from: "App.OnStart"
      to: "NotificationStack"
      via: "ClearCollect initialization"
      pattern: "ClearCollect\\(NotificationStack.*Table\\(\\)"
---

## Objective

Implement the core notification system infrastructure: toast state management, notification trigger UDFs, and helper functions for color/icon/timing logic. This plan creates the foundation that the UI layer (04-02) will render, and enables developers to call `NotifySuccess()`, `NotifyError()`, etc. and have notifications automatically tracked and managed.

**Purpose:** Establish non-blocking notification delivery mechanism with proper lifecycle (add → display → auto-dismiss → remove).

**Output:**
- Enhanced App-Formulas-Template.fx with ToastConfig Named Formula, GetToast* UDFs, and AddToast/RemoveToast helpers
- Notification state initialization in App-OnStart-Minimal.fx
- All existing NotifySuccess/NotifyError/NotifyWarning/NotifyInfo UDFs enhanced to call AddToast internally

## Execution Context

@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md

## Context

@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/04-user-experience-documentation/04-CONTEXT.md
@.planning/phases/04-user-experience-documentation/04-RESEARCH.md

Codebase References:
- @src/App-Formulas-Template.fx (existing notification UDFs, ThemeColors Named Formula)
- @src/App-OnStart-Minimal.fx (existing state variable structure, Section 5 background collections pattern)

## Tasks

<task type="auto">
  <name>Task 1: Create ToastConfig Named Formula and color/icon/duration helper UDFs</name>
  <files>src/App-Formulas-Template.fx</files>
  <action>
In App-Formulas-Template.fx, after the existing notification UDFs (line 876), add a new section for toast configuration and helper functions:

1. Create ToastConfig Named Formula (lines 880-895):
   - Width: 350 (pixels, used by UI controls)
   - MaxWidth: 400
   - SuccessDuration: 5000 (ms)
   - WarningDuration: 5000
   - InfoDuration: 5000
   - ErrorDuration: 0 (never auto-dismiss)
   - AnimationDuration: 300

2. Create GetToastBackground(toastType: Text) UDF (lines 900-910):
   - Return ThemeColors.SuccessLight for "Success"
   - Return ThemeColors.ErrorLight for "Error"
   - Return ThemeColors.WarningLight for "Warning"
   - Return ColorValue("#E7F4FF") for "Info"
   - Return ThemeColors.Surface as fallback

3. Create GetToastBorderColor(toastType: Text) UDF (lines 915-925):
   - Return ThemeColors.Success for "Success"
   - Return ThemeColors.Error for "Error"
   - Return ThemeColors.Warning for "Warning"
   - Return ThemeColors.Info for "Info"
   - Return ThemeColors.Border as fallback

4. Create GetToastIcon(toastType: Text) UDF (lines 930-940):
   - Return "✓" (checkmark) for "Success"
   - Return "✕" (X mark) for "Error"
   - Return "⚠" (warning triangle) for "Warning"
   - Return "ℹ" (info circle) for "Info"
   - Return "" as fallback

5. Create GetToastIconColor(toastType: Text) UDF (lines 945-955):
   - Return ThemeColors.Success for "Success"
   - Return ThemeColors.Error for "Error"
   - Return ThemeColors.Warning for "Warning"
   - Return ThemeColors.Info for "Info"
   - Return ThemeColors.Text as fallback

All helper UDFs follow PascalCase naming convention with "Get" prefix. Add inline comments documenting purpose and return values.
  </action>
  <verify>
Run Power Apps Studio Monitor tool:
1. Open the app and navigate to the formulas bar
2. Type ToastConfig and verify it auto-completes and shows all 7 fields
3. Type GetToastBackground("Success") and verify it returns a color (not error)
4. Type GetToastIcon("Error") and verify it returns "✕"
5. Verify all 5 UDFs exist in the formula editor's auto-complete list
  </verify>
  <done>ToastConfig Named Formula provides configuration values, 4 GetToast* UDFs provide color/icon/duration lookup by type, all follow naming conventions and ThemeColors reference</done>
</task>

<task type="auto">
  <name>Task 2: Create AddToast and RemoveToast helper UDFs</name>
  <files>src/App-Formulas-Template.fx</files>
  <action>
In App-Formulas-Template.fx, after the GetToast* UDFs (line 955), add helper UDFs for toast lifecycle management:

1. Create AddToast(message: Text; toastType: Text; shouldAutoClose: Boolean; duration: Number) UDF (lines 960-985):
   - Use Patch() to add new row to NotificationStack collection with schema:
     * ID: NotificationCounter (unique identifier)
     * Message: message parameter
     * Type: toastType parameter (passed to GetToast* functions)
     * AutoClose: shouldAutoClose parameter
     * Duration: duration parameter (ms)
     * CreatedAt: Now() (timestamp for expiry calculation)
     * IsVisible: true (controls visibility in UI layer)
   - Increment NotificationCounter via Set(NotificationCounter, NotificationCounter + 1)
   - Do NOT implement timer logic here (deferred to UI layer with Timer control)
   - Add comment: "// Note: Auto-dismiss logic handled by UI timer control in 04-02"
   - Handle case where NotificationStack collection doesn't exist (won't happen if OnStart initializes, but document assumption)

2. Create RemoveToast(toastID: Number) UDF (lines 990-1000):
   - Use Remove() to delete the toast with matching ID from NotificationStack
   - Use LookUp(NotificationStack, ID = toastID) to find the row
   - Handle case where toast already removed (IfError with silent ignore)
   - Document: "Called by toast close button or auto-dismiss timer"

Both UDFs follow Notify* action pattern (curly braces, Void return). Add inline comments explaining purpose and usage.
  </action>
  <verify>
In Power Apps Monitor or formula bar:
1. Type AddToast("Test", "Success", true, 5000) and execute
2. Check Monitor: NotificationStack collection should have 1 row with correct fields
3. Check Monitor: Row should have ID=0, Message="Test", Type="Success", AutoClose=true, Duration=5000
4. Type AddToast("Error", "Error", false, 0) and execute
5. Check Monitor: NotificationStack should have 2 rows (ID=1 should exist)
6. Type RemoveToast(0) and execute
7. Check Monitor: NotificationStack should have 1 row remaining (ID=0 removed, ID=1 still present)
  </verify>
  <done>AddToast adds rows to NotificationStack with correct schema, RemoveToast deletes specific toast by ID, NotificationCounter increments on each add, collection persists across multiple operations</done>
</task>

<task type="auto">
  <name>Task 3: Enhance existing NotifySuccess/NotifyError/NotifyWarning/NotifyInfo to call AddToast</name>
  <files>src/App-Formulas-Template.fx</files>
  <action>
In App-Formulas-Template.fx, modify the existing notification UDFs (lines 859-876) to call AddToast internally:

1. Update NotifySuccess(message: Text) UDF (line 859):
   - Keep existing Notify() call (Power Apps system notification)
   - Add AddToast() call: AddToast(message, "Success", true, ToastConfig.SuccessDuration)
   - Change to multi-statement: Notify(...); AddToast(...)
   - Use curly braces for multi-statement behavior: NotifySuccess(message: Text): Void = { ... }

2. Update NotifyError(message: Text) UDF (line 864):
   - Keep existing Notify() call
   - Add AddToast() call: AddToast(message, "Error", false, ToastConfig.ErrorDuration)
   - Error does NOT auto-close (shouldAutoClose = false, duration = 0)

3. Update NotifyWarning(message: Text) UDF (line 869):
   - Keep existing Notify() call
   - Add AddToast() call: AddToast(message, "Warning", true, ToastConfig.WarningDuration)

4. Update NotifyInfo(message: Text) UDF (line 874):
   - Keep existing Notify() call
   - Add AddToast() call: AddToast(message, "Info", true, ToastConfig.InfoDuration)

5. For NotifyPermissionDenied, NotifyActionCompleted, NotifyValidationError (lines 879-899):
   - These composite notification UDFs should also call AddToast with appropriate type
   - NotifyPermissionDenied: AddToast(..., "Error", false, 0)
   - NotifyActionCompleted: AddToast(..., "Success", true, ToastConfig.SuccessDuration)
   - NotifyValidationError: AddToast(..., "Warning", true, ToastConfig.WarningDuration)

Do NOT remove existing Notify() calls (dual notification: system banner + custom toast).
  </action>
  <verify>
In Power Apps Monitor:
1. Call NotifySuccess("Saved") and check Monitor: NotificationStack should have 1 row with Type="Success", AutoClose=true
2. Call NotifyError("Failed") and check Monitor: NotificationStack should have 2 rows with Type="Error", AutoClose=false
3. Call NotifyWarning("Warning") and check: Type="Warning", AutoClose=true
4. Call NotifyInfo("Info") and check: Type="Info", AutoClose=true
5. Verify NotificationStack collection persists all 4 notifications without loss
6. Call RemoveToast multiple times and verify collection shrinks correctly
  </verify>
  <done>All 7 Notify* UDFs now call AddToast internally, error notifications don't auto-close (AutoClose=false, Duration=0), success/warning/info auto-close after configured timeout, system Notify() banner still appears for backward compatibility</done>
</task>

<task type="auto">
  <name>Task 4: Initialize NotificationStack collection and supporting variables in App.OnStart</name>
  <files>src/App-OnStart-Minimal.fx</files>
  <action>
In App-OnStart-Minimal.fx, add Section 7 for notification state initialization (after Section 6: User-Scoped Data, which ends around line 250):

1. Add section header (lines 255-262):
   - Section title: "// ============================================================"
   - Section label: "// SECTION 7: NOTIFICATION STACK (NEW in Phase 4)"
   - Purpose comment: "// Purpose: Initialize toast notification state"
   - Timing note: "// Timing: 100-200ms (background loading, doesn't block critical path)"

2. Add NotificationStack collection initialization (lines 265-270):
   - ClearCollect(NotificationStack, Table()) - Start with empty table
   - Document schema: "// Schema: { ID, Message, Type, AutoClose, Duration, CreatedAt, IsVisible }"
   - This MUST come before other notification variables (dependency)

3. Add NotificationCounter variable (lines 275-280):
   - Set(NotificationCounter, 0)
   - Comment: "// Counter: Unique ID for each toast (incremented in AddToast)"

4. Add ToastToRemove variable (lines 285-290):
   - Set(ToastToRemove, Blank())
   - Comment: "// For auto-dismiss: Store current toast ID being dismissed (used by timer in controls)"

5. Optional: Add periodic cleanup safety net (lines 295-305, commented out by default):
   - Document that unbounded collection growth is prevented by auto-dismiss timers
   - Include pattern for manual cleanup: "ForAll(Filter(NotificationStack, Now() - CreatedAt > TimeValue(\"0:0:30\")), Remove(...))"
   - Mark as optional: "// OPTIONAL: Uncomment if you notice collection growing unbounded"

Location: Section 7 should initialize AFTER Section 6 (user-scoped data) but its execution can be in parallel with other background data (Concurrent block if appropriate - check existing structure).

Keep initialization order: (1) NotificationStack collection first, (2) then counter, (3) then remove tracking variable.
  </action>
  <verify>
In Power Apps Monitor after app opens:
1. Check Collections tab: NotificationStack should exist and be empty (0 rows)
2. Type NotificationCounter in formula bar and verify it equals 0
3. Type ToastToRemove in formula bar and verify it's Blank()
4. In a form/button handler, call NotifySuccess("Test") and verify NotificationStack has 1 row
5. Call NotifyError("Error") and verify NotificationStack has 2 rows
6. Verify app startup time (<2000ms) not affected by notification initialization
  </verify>
  <done>NotificationStack collection initialized empty, NotificationCounter starts at 0, ToastToRemove initialized Blank(), all three variables ready for use by 04-02 UI layer, no startup time regression</done>
</task>

<task type="auto">
  <name>Task 5: Add inline code comments documenting notification system architecture and usage</name>
  <files>src/App-Formulas-Template.fx, src/App-OnStart-Minimal.fx</files>
  <action>
Add comprehensive inline documentation to explain the notification system for future developers:

In App-Formulas-Template.fx (lines 878-882, before ToastConfig):
- Add 8-10 line comment block explaining:
  - "Toast Notification System (Phase 4)"
  - Layer 1: UDFs (NotifySuccess, NotifyError, etc.) - public API, developers call these
  - Layer 2: State (NotificationStack collection) - tracks active toasts
  - Layer 3: UI (Control-Patterns-Modern.fx, cnt_NotificationStack) - renders toasts (defined in 04-02)
  - Example: "Call NotifySuccess('Record saved') → AddToast updates NotificationStack → UI renders toast"
  - Note: "Keep these UDFs in App.Formulas; keep UI container formulas in Control-Patterns-Modern.fx"

In App-Formulas-Template.fx (after GetToastIcon, lines 955-960):
- Add comment explaining AddToast/RemoveToast relationship:
  - "AddToast: Called by NotifySuccess/NotifyError/etc. (or directly if custom notification needed)"
  - "RemoveToast: Called by UI close button or auto-dismiss timer"
  - "Never call these directly in controls; they are helper UDFs for the layer below"

In App-OnStart-Minimal.fx (Section 7, lines 260-265):
- Add brief architecture note:
  - "NotificationStack is a session-scoped collection (cleared when app closes)"
  - "Each toast has CreatedAt timestamp so auto-dismiss can calculate elapsed time"
  - "AutoClose flag determines if toast auto-removes (errors: false, others: true)"

These comments are for developer understanding, not user documentation (that goes in CLAUDE.md in 04-03).
  </action>
  <verify>
Open App-Formulas-Template.fx and App-OnStart-Minimal.fx:
1. Verify comments appear before ToastConfig (explaining overall architecture)
2. Verify comments appear before AddToast/RemoveToast (explaining lifecycle)
3. Verify comments appear in Section 7 (explaining state initialization)
4. Comments should be readable (not technical jargon, explain "why" not just "what")
5. No comments should reference UI controls (that's 04-02 responsibility)
  </verify>
  <done>Inline comments added explaining toast notification layers, architecture philosophy, and usage patterns for future developers reading template code</done>
</task>

## Verification

After all tasks complete, verify:

1. **ToastConfig Named Formula exists:** Type `ToastConfig.Width` in formula bar → returns 350
2. **GetToast* UDFs exist (5 total):** GetToastBackground, GetToastBorderColor, GetToastIcon, GetToastIconColor, plus 1 more reference
3. **AddToast/RemoveToast UDFs exist (2 total):** Call AddToast("test", "Success", true, 5000) → NotificationStack grows; call RemoveToast(0) → row removed
4. **NotificationStack collection initialized:** App.OnStart runs, Monitor shows NotificationStack exists with 0 rows
5. **Notification UDFs enhanced:** Call NotifySuccess("Test") → Monitor shows NotificationStack has 1 row; call NotifyError("Fail") → Type="Error", AutoClose=false
6. **No startup time regression:** Monitor shows App.OnStart <2000ms total duration (notification init is <200ms)

## Success Criteria

1. All notification trigger UDFs (NotifySuccess, NotifyError, NotifyWarning, NotifyInfo) work without developer intervention
2. NotificationStack collection properly tracks all active toasts with no data loss across multiple simultaneous calls
3. Error notifications have AutoClose=false, info/success/warning have AutoClose=true with correct durations
4. Duplicate toast IDs never occur (NotificationCounter increments correctly)
5. RemoveToast correctly removes specific toasts by ID without affecting other toasts
6. App startup time remains <2000ms (notification init is non-blocking, ~100-200ms)
7. Inline comments explain architecture for future developers

## Output

After completion, create `.planning/phases/04-user-experience-documentation/04-01-SUMMARY.md` with:
- List of all new UDFs and Named Formulas created
- NotificationStack collection schema documentation
- Examples of calling AddToast for common scenarios (form submit, validation error, approval action)
- Architecture diagram: How Notify* UDFs → AddToast → NotificationStack → UI layer (04-02)
- Test results from Monitor showing collection operations and stack timings
