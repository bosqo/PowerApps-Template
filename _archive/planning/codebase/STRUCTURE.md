# Codebase Structure

**Analysis Date:** 2026-01-18

## Directory Layout

```
PowerApps-Vibe-Claude/
├── .auto-claude/       # Auto-generated AI planning artifacts
├── .claude/            # Claude Code configuration
│   ├── commands/       # Custom slash commands
│   └── skills/         # Domain-specific skills
├── .planning/          # Planning and codebase analysis
│   └── codebase/       # This directory
├── docs/               # Architecture and migration guides
├── log/                # Historical audit and review logs
├── src/                # Power Fx source code (templates)
├── deploy-*.bat        # Deployment automation scripts
├── deploy-solution.ps1 # PowerShell deployment logic
├── CLAUDE.md           # Project instructions for Claude
├── DEPLOYMENT-*.md     # Deployment documentation
├── QUICK-START.md      # One-page deployment reference
└── README.md           # Project overview
```

## Directory Purposes

**.auto-claude/**
- Purpose: Automated Claude planning artifacts (ideation, specs, roadmap)
- Contains: Generated documentation from AI-assisted planning
- Key files: Subdirectories for ideation, insights, roadmap, specs

**.claude/**
- Purpose: Claude Code configuration and custom commands
- Contains: commands/ (custom slash commands), skills/ (domain skills), settings.local.json
- Key files: `commands/reflect.md` (session reflection command), `skills/power-apps/SKILL.md`, `skills/dataverse/SKILL.md`

**.planning/codebase/**
- Purpose: Structured codebase analysis for GSD workflow
- Contains: This directory with ARCHITECTURE.md, STRUCTURE.md, STACK.md, INTEGRATIONS.md, CONVENTIONS.md, TESTING.md, CONCERNS.md
- Key files: Generated by /gsd:map-codebase command

**docs/**
- Purpose: Human-readable architecture and migration documentation
- Contains: Design docs, migration guides, schema definitions
- Key files: `App-Formulas-Design.md`, `MIGRATION-GUIDE.md`, `MODERNIZATION-PLAN.md`, `DEPLOYMENT-GUIDE.md`, `DATAVERSE-ITEM-SCHEMA.md`

**log/**
- Purpose: Historical audit trails and code review logs
- Contains: Past analysis reports
- Key files: `AUDIT-REPORT.md`, `CODE-REVIEW-2025.md`, `CODE-REFACTORING-SUMMARY-2025.md`

**src/**
- Purpose: Power Fx templates for Canvas App development
- Contains: App.Formulas template, App.OnStart template, control patterns
- Key files: `App-Formulas-Template.fx`, `App-OnStart-Minimal.fx`, `Control-Patterns-Modern.fx`, `Datasource-Filter-Patterns.fx`

**Root deployment files:**
- Purpose: ALM automation for DEV→TEST→PROD workflow
- Contains: Batch wrappers and PowerShell core logic
- Key files: `deploy-dev.bat`, `deploy-test.bat`, `deploy-prod.bat`, `deploy-solution.ps1`

## Key File Locations

**Entry Points:**
- `src/App-Formulas-Template.fx`: Declarative layer (Named Formulas + 30+ UDFs)
- `src/App-OnStart-Minimal.fx`: Imperative initialization (state + collections)

**Configuration:**
- `CLAUDE.md`: Project instructions and naming conventions
- `.claude/settings.local.json`: Claude Code local settings
- `.env.example`: Environment variable template for deployment

**Core Logic:**
- `src/App-Formulas-Template.fx:25-96`: Theme, Typography, Spacing, BorderRadius configs
- `src/App-Formulas-Template.fx:98-147`: AppConfig, DateRanges Named Formulas
- `src/App-Formulas-Template.fx:155-283`: User context (Profile, Roles, Permissions, FeatureFlags)
- `src/App-Formulas-Template.fx:286-758`: 30+ UDFs (permissions, validation, formatting, timezone)

**Control Patterns:**
- `src/Control-Patterns-Modern.fx:44-216`: Gallery patterns (basic, filtered, paginated, search)
- `src/Control-Patterns-Modern.fx:218-287`: Visibility patterns (permission-based, role-based)
- `src/Control-Patterns-Modern.fx:288-363`: Color patterns (status, priority, theme)
- `src/Control-Patterns-Modern.fx:381-502`: Text/label patterns (dates, formatting, currency)
- `src/Control-Patterns-Modern.fx:533-657`: Button OnSelect patterns (CRUD with permissions)
- `src/Control-Patterns-Modern.fx:660-782`: Form and screen patterns

**Testing:**
- No dedicated test directory (Power Apps testing is manual/UI-based)
- Debug mode via URL parameters documented in `docs/MIGRATION-GUIDE.md:418-434`

**Deployment:**
- `deploy-solution.ps1`: Core PAC CLI orchestration (export, pack, import)
- `DEPLOYMENT-INSTRUCTIONS.md`: Step-by-step manual deployment
- `DEPLOYMENT-WORKFLOW.md`: Visual workflow diagrams and decision trees
- `DEPLOYMENT-CHEATSHEET.md`: Quick command reference

## Naming Conventions

**Files:**
- Power Fx templates: `PascalCase-Hyphenated.fx` (e.g., `App-Formulas-Template.fx`)
- Documentation: `UPPERCASE.md` or `PascalCase-Hyphenated.md`
- Scripts: `kebab-case.bat`, `kebab-case.ps1`

**Directories:**
- Lowercase with hyphens: `.auto-claude/`, `.planning/`
- No hyphens for single words: `docs/`, `log/`, `src/`

**Power Fx Named Formulas:**
- PascalCase: `ThemeColors`, `UserProfile`, `DateRanges`, `AppConfig`

**Power Fx UDFs:**
- PascalCase with verb: `HasPermission()`, `CanAccessRecord()`, `GetRoleLabel()`, `FormatDateShort()`

**Power Fx Variables:**
- PascalCase: `AppState`, `ActiveFilters`, `UIState`, `DashboardCounts`

**Power Fx Collections:**
- PascalCase with prefix: `CachedDepartments`, `MyRecentItems`, `MyPendingTasks`

**Controls (Canvas App convention):**
- `Type_Name` format: `Gallery_Items`, `Button_Submit`, `Label_Error`, `TextInput_Search`

## Where to Add New Code

**New Named Formula (static config):**
- Primary code: `src/App-Formulas-Template.fx` Section 1 (lines 19-148)
- Usage: Reference directly in controls (e.g., `ThemeColors.Primary`)

**New UDF (reusable function):**
- Implementation: `src/App-Formulas-Template.fx` Section 3 (lines 286-758)
- Tests: Manual testing in Canvas App controls
- Usage: Call from any control or screen (e.g., `HasPermission("Delete")`)

**New State Variable:**
- Initialization: `src/App-OnStart-Minimal.fx` Sections 1-3 (lines 30-112)
- Usage: Access via variable name (e.g., `AppState.IsLoading`)

**New Collection Loading:**
- Implementation: `src/App-OnStart-Minimal.fx` Section 4-5 (lines 114-242)
- Use Concurrent() for parallel loading when possible
- Usage: Reference collection in Gallery.Items or formulas

**New Control Pattern:**
- Primary code: `src/Control-Patterns-Modern.fx` in appropriate section
- Document with BEFORE/AFTER examples
- Include pattern number and descriptive name

**Utilities (Deployment):**
- Shared scripts: `deploy-solution.ps1` (functions at top)
- Wrapper scripts: `deploy-*.bat` (simple environment-specific calls)

**New Documentation:**
- Architecture/design: `docs/` with descriptive name
- Deployment: Root directory with `DEPLOYMENT-` prefix
- Historical logs: `log/` with `YYYY-MM-DD` or year suffix

## Special Directories

**.auto-claude/**
- Purpose: AI-generated planning artifacts
- Generated: Yes (by Auto-Claude extension)
- Committed: Yes (for team visibility)

**.claude/**
- Purpose: Claude Code configuration
- Generated: Mixed (commands manual, settings local)
- Committed: commands/ yes, settings.local.json no (gitignored)

**.planning/codebase/**
- Purpose: Codebase analysis for GSD workflow
- Generated: Yes (by /gsd:map-codebase command)
- Committed: Yes (consumed by /gsd:plan-phase and /gsd:execute-phase)

**.git/**
- Purpose: Git version control
- Generated: Yes (by git init)
- Committed: No (part of .git infrastructure)

**log/**
- Purpose: Historical audit trails
- Generated: Manual or by review processes
- Committed: Yes (for audit compliance)

**docs/**
- Purpose: Living documentation
- Generated: Manual with occasional AI assistance
- Committed: Yes (essential reference material)

## File Relationships

**App.Formulas → App.OnStart:**
- App.OnStart imports UDFs from App.Formulas
- Example: `GetUserScope()` at `src/App-OnStart-Minimal.fx:66`
- Direction: App.OnStart depends on App.Formulas

**App.Formulas → Controls:**
- Controls reference Named Formulas and call UDFs
- Example: `ThemeColors.Primary` at `src/Control-Patterns-Modern.fx:344`
- Direction: Controls depend on App.Formulas

**App.OnStart → Controls:**
- Controls read/write state variables from OnStart
- Example: `ActiveFilters.SearchTerm` at `src/Control-Patterns-Modern.fx:136`
- Direction: Controls depend on App.OnStart state

**CLAUDE.md → All:**
- Project instructions guide all code and documentation
- Referenced by Claude Code for context
- Direction: One-way (instructions to implementation)

**docs/ → src/:**
- Documentation explains implementation patterns
- Example: `docs/App-Formulas-Design.md` explains `src/App-Formulas-Template.fx`
- Direction: Documentation describes code (not enforced)

**Deployment scripts → Power Platform CLI:**
- Batch/PowerShell scripts wrap PAC CLI commands
- Example: `deploy-solution.ps1` calls `pac solution export`
- Direction: Scripts orchestrate CLI

## Import/Export Patterns

**Canvas App Export:**
```powershell
pac canvas download --name "MyApp" --file MyApp.msapp
pac canvas unpack --msapp MyApp.msapp --sources ./src
```

**Canvas App Import (from source):**
```powershell
pac canvas pack --sources ./src --msapp MyApp.msapp
# Upload MyApp.msapp via Power Apps Studio
```

**Solution Export:**
```powershell
pac solution export --name MySolution --path ./exports/MySolution.zip
pac solution unpack --zipfile ./exports/MySolution.zip --folder ./src/solution
```

**Solution Import:**
```powershell
pac solution pack --folder ./src/solution --zipfile ./MySolution.zip
pac solution import --path ./MySolution.zip
```

---

*Structure analysis: 2026-01-18*
