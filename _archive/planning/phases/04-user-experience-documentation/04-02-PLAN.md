---
phase: 04-user-experience-documentation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Control-Patterns-Modern.fx
  - src/App-OnStart-Minimal.fx
autonomous: true

must_haves:
  truths:
    - "Toast notifications appear in top-right corner of screen as non-blocking overlay"
    - "Multiple toasts stack vertically without overlapping, with newest toast on top"
    - "Toast colors match Fluent Design semantic colors (blue/green/amber/red)"
    - "Each toast displays icon matching notification type (checkmark/X/warning/info)"
    - "Success/info/warning toasts disappear after 5 seconds; error toasts require manual close"
    - "Clicking X button removes individual toast immediately from stack"
    - "Toasts animate smoothly on entrance (slide-in) and exit (fade)"
    - "Content behind toasts remains interactive; toasts don't block user actions"
  artifacts:
    - path: "src/Control-Patterns-Modern.fx"
      provides: "cnt_NotificationStack container pattern + child toast control formulas"
      min_lines: 300
    - path: "src/App-OnStart-Minimal.fx"
      provides: "Timer initialization for auto-dismiss functionality"
      min_lines: 10
  key_links:
    - from: "cnt_NotificationStack.Items"
      to: "NotificationStack collection"
      via: "formula binding"
      pattern: "\\$\\{NotificationStack\\}"
    - from: "cnt_Toast child controls"
      to: "GetToast* UDFs"
      via: "dynamic property formulas"
      pattern: "GetToastBackground\\(ThisItem.Type\\)"
    - from: "btn_CloseToast.OnSelect"
      to: "RemoveToast UDF"
      via: "click handler"
      pattern: "RemoveToast\\(ThisItem.ID\\)"
---

## Objective

Implement the toast notification UI layer: container control patterns, child toast tiles, animations, and interactive dismissal. This plan creates the visual and interactive components that render the notifications managed by 04-01, enabling developers to see toasts appear, stack, auto-dismiss, and be manually closed.

**Purpose:** Translate notification state (NotificationStack collection) into polished, animated Fluent Design toast UI.

**Output:**
- Toast container pattern (cnt_NotificationStack) in Control-Patterns-Modern.fx with full property formulas
- Individual toast tile pattern (cnt_Toast) with icon, message, and close button
- Auto-dismiss timer logic for non-blocking dismissal
- Animations for slide-in entrance and fade-out exit
- All controls positioned top-right with proper z-index and overflow handling

## Execution Context

@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md

## Context

@.planning/phases/04-user-experience-documentation/04-CONTEXT.md
@.planning/phases/04-user-experience-documentation/04-RESEARCH.md
@.planning/phases/04-01-SUMMARY.md (after 04-01 completes)

Codebase References:
- @src/Control-Patterns-Modern.fx (existing pattern structure, control naming conventions)
- @src/App-Formulas-Template.fx (ThemeColors, ToastConfig, GetToast* UDFs from 04-01)

## Tasks

<task type="auto">
  <name>Task 1: Create main toast container (cnt_NotificationStack) pattern with position/visibility formulas</name>
  <files>src/Control-Patterns-Modern.fx</files>
  <action>
In Control-Patterns-Modern.fx, add a new section for notification patterns (after existing control patterns, around line 500):

1. Add section header (lines 505-510):
   - "// ============================================================"
   - "// PATTERN 1.9: TOAST NOTIFICATION CONTAINER"
   - "// ============================================================"

2. Create cnt_NotificationStack container pattern (lines 515-600):
   - Container type: Vertical (auto-stacks children top-to-bottom)
   - Purpose comment: "Fixed overlay positioned top-right; shows all active toasts"

   Document these property formulas:

   a) Items property (line 520):
      - Formula: NotificationStack
      - Comment: "Bind to notification collection from 04-01"

   b) X property (line 525):
      - Formula: Parent.Width - 400
      - Comment: "Position at right edge (400px width + margins)"

   c) Y property (line 530):
      - Formula: 16
      - Comment: "Top padding (16px from screen top, Fluent Design spacing)"

   d) Width property (line 535):
      - Formula: If(CountRows(NotificationStack) > 0, 380, 0)
      - Comment: "350px content + 30px padding; collapse to 0 when empty to avoid click zone"

   e) Height property (line 540):
      - Formula: Parent.Height - 32
      - Comment: "Full height minus top/bottom spacing; auto-layout handles child sizing"

   f) LayoutMode property (line 545):
      - Formula: LayoutMode.Vertical
      - Comment: "Stack toasts vertically, newest on top (Power Apps adds to collection end)"

   g) ClipContents property (line 550):
      - Formula: false
      - Comment: "Allow toast animations to overflow container if needed"

   h) ZIndex property (line 555):
      - Formula: 1000
      - Comment: "Render on top of galleries, forms, and other content"

   i) Visible property (line 560):
      - Formula: CountRows(NotificationStack) > 0
      - Comment: "Hide completely when no toasts (prevents empty floating container)"

   j) Fill property (line 565):
      - Formula: RGBA(0, 0, 0, 0)
      - Comment: "Transparent background (only child toasts have colored backgrounds)"

   k) Padding property (line 570):
      - Formula: 8
      - Comment: "8px padding around entire stack (Fluent Design spacing)"

   l) Spacing property (line 575):
      - Formula: 12
      - Comment: "12px gap between individual toasts for visual separation"

3. Add child toast pattern description (lines 585-600):
   - Comment block explaining: "Children: cnt_Toast tiles, repeating for each NotificationStack row"
   - Each toast automatically renders with its own styling, icon, message, and close button
   - Specific formulas for toast children documented separately (Task 2)

All formulas use existing Named Formulas (ThemeColors, ToastConfig from 04-01) and don't require custom power apps controls.
  </action>
  <verify>
After adding formulas to Control-Patterns-Modern.fx:
1. Open Power Apps Studio and load the canvas app
2. In the tree view (left panel), verify cnt_NotificationStack container exists
3. Check container properties panel: X should be "Parent.Width - 400", Y should be "16", ZIndex should be "1000"
4. Call NotifySuccess("Test") from a formula bar test
5. Verify toast appears in top-right corner (not left, bottom, or center)
6. Verify toast doesn't overlap with other controls (gallery, form, etc.)
7. Call NotifyError("Error1") and NotifySuccess("Success") - verify both toasts visible without overlap
8. Hide app content (cover with another screen) and verify toasts still visible on top layer
  </verify>
  <done>cnt_NotificationStack container positioned top-right, fixed overlay, proper spacing and z-index, hides when empty, binds to NotificationStack collection for dynamic rendering</done>
</task>

<task type="auto">
  <name>Task 2: Create individual toast tile (cnt_Toast) pattern with dynamic styling and close button</name>
  <files>src/Control-Patterns-Modern.fx</files>
  <action>
In Control-Patterns-Modern.fx, immediately after cnt_NotificationStack pattern (lines 605-750), add child toast tile pattern:

1. Create cnt_Toast container pattern (lines 610-700):
   - Container type: Horizontal (icon | message | close button side-by-side)
   - Purpose comment: "Individual toast tile, repeats for each NotificationStack row"

   Document these property formulas for styling:

   a) Fill property (line 615):
      - Formula: GetToastBackground(ThisItem.Type)
      - Comment: "Dynamic background color per type (Success=green light, Error=red light, etc.)"

   b) BorderColor property (line 620):
      - Formula: GetToastBorderColor(ThisItem.Type)
      - Comment: "Colored left/top border per type for visual accent"

   c) BorderThickness property (line 625):
      - Formula: 2
      - Comment: "Visible 2px border to distinguish toast from content behind"

   d) CornerRadius property (line 630):
      - Formula: 4
      - Comment: "Rounded corners (4px) per Fluent Design standard"

   e) Padding property (line 635):
      - Formula: 12
      - Comment: "12px padding around contents (icon + message + button)"

   f) Height property (line 640):
      - Formula: Auto
      - Comment: "Let content determine height; grows with message length"

   g) Width property (line 645):
      - Formula: ToastConfig.Width
      - Comment: "Use configured width (350px from ToastConfig Named Formula)"

   h) Visible property (line 650):
      - Formula: If(ThisItem.AutoClose && Now() - ThisItem.CreatedAt > TimeValue("0:0:5"), false, true)
      - Comment: "Hide after 5 seconds if AutoClose=true (fade-out effect)"
      - Note: "Also removed from collection by automatic cleanup or manual RemoveToast()"

   i) BorderStyle property (line 655):
      - Formula: BorderStyle.Solid
      - Comment: "Solid border (not dotted/dashed)"

2. Add child control descriptions (lines 705-750) for three child controls that repeat inside cnt_Toast:

   Child 1 - Icon (ico_ToastIcon):
   - Type: Icon or Label (using Unicode character)
   - Formula properties (lines 710-720):
     * Text/Value: GetToastIcon(ThisItem.Type)
     * Color: GetToastIconColor(ThisItem.Type)
     * Size: 24
     * AccessibleLabel: ThisItem.Type & " notification"

   Child 2 - Message (lbl_ToastMessage):
   - Type: Label
   - Formula properties (lines 725-740):
     * Text: ThisItem.Message
     * FontSize: 14 (or Typography.SizeMD if available)
     * Color: ThemeColors.Text
     * WordWrap: true
     * AutoHeight: true
     * Comment: "Text can wrap; message height grows automatically"

   Child 3 - Close Button (btn_CloseToast):
   - Type: Button
   - Formula properties (lines 745-760):
     * Text: "✕" (Unicode X)
     * OnSelect: RemoveToast(ThisItem.ID)
     * HoverFill: ThemeColors.SurfaceHover
     * DisplayMode: DisplayMode.Edit (always interactive)
     * AccessibleLabel: "Close " & ThisItem.Type & " notification"
     * Comment: "Positioned top-right of toast; clicking removes toast immediately"

All formulas use UDFs from 04-01 (GetToast*) and ThisItem context for dynamic data binding.
  </action>
  <verify>
After adding cnt_Toast pattern to Control-Patterns-Modern.fx:
1. Call NotifySuccess("Record saved") and verify:
   - Toast appears with green background
   - Green checkmark (✓) icon appears on left
   - Message text reads "Record saved"
   - X button appears on right side of toast
2. Call NotifyError("Failed to save") and verify:
   - Toast appears with red background
   - Red X (✕) icon appears
   - Message text reads "Failed to save"
3. Call NotifyWarning("Long message that might wrap across multiple lines to test text wrapping behavior") and verify:
   - Toast background is amber/yellow
   - Warning triangle (⚠) icon appears
   - Message wraps to multiple lines within 350px width
   - Toast height grows with message
4. Verify each toast has independent X button that removes only that toast
5. Verify toast styling changes based on Type (Success/Error/Warning/Info)
  </verify>
  <done>Individual toast tiles render with correct background color, icon, message text, and close button per notification type; styling dynamically applied via GetToast* UDFs; child controls properly positioned and sized</done>
</task>

<task type="auto">
  <name>Task 3: Implement slide-in animation for toast entrance</name>
  <files>src/Control-Patterns-Modern.fx</files>
  <action>
In Control-Patterns-Modern.fx, enhance cnt_Toast pattern (around line 680) with animation formula for smooth slide-in:

1. Add animation logic to cnt_Toast (lines 675-690):

   a) Add OnVisible event handler (if supported in Power Apps):
      - Or use alternative: Set(ToastAnimationStart, Now()) to track animation start time
      - Comment: "Triggered when toast appears in cnt_NotificationStack"

   b) Modify X property (or equivalent position offset) for slide-in effect (lines 695-710):
      - Logic: Toast starts off-screen to the right, slides left into view
      - Formula (pseudo-code):
        ```
        If(
          IsBlank(ToastAnimationStart),
          ToastConfig.Width,  // Start off-screen right (not visible)
          If(
            Now() - ToastAnimationStart < TimeValue("0:0:0.3"),  // 300ms animation duration
            ToastConfig.Width * (1 - ((Now() - ToastAnimationStart) / TimeValue("0:0:0.3"))),
            0  // Final position on-screen
          )
        )
        ```
      - Comment: "Smooth slide from right (width) to left (0) over 300ms"
      - Note: "May need to use Rotate or X offset depending on Power Apps version"

   c) Alternative simpler approach (if animation formula too complex):
      - Use built-in Animation property: Animation.SlideInLeft or similar
      - Or use Opacity fade-in: Opacity goes from 0 to 1 over 300ms
      - Comment: "Platform built-in animations may be simpler than manual timing"

   d) Reset animation state when toast removed:
      - When RemoveToast(ThisItem.ID) called, set ToastAnimationStart to Blank()
      - Prevents animation state lingering for future toasts

2. Document animation timing (lines 715-720):
   - Animation duration: 300ms (matches ToastConfig.AnimationDuration)
   - Easing: Linear (simplest; could be improved to ease-out later)
   - Entrance: Slide in from right
   - Exit: Handled by Visible property fade (Task 4)

Choose the animation approach that works best with your Power Apps version:
- **Preferred:** Manual X offset with Now() timing (most control, works on all versions)
- **Alternative:** Built-in Animation property (simpler, but less customizable)
- **Fallback:** No animation (still works, just less polished)

Document your chosen approach in comments.
  </action>
  <verify>
After implementing slide-in animation:
1. Call NotifySuccess("Test") and watch toast appear
2. Verify toast smoothly slides in from right edge to final position (NOT appear instantly)
3. Duration should be ~300ms (noticeable but quick, not slow)
4. Call NotifyError("Error") while first toast still sliding - verify both animate simultaneously
5. Verify animation doesn't cause performance lag (app remains responsive during animation)
6. Open Monitor: Check animation duration is approximately 300-350ms (allowable margin)
  </verify>
  <done>Toast notification slides in smoothly from right edge over 300ms when created, multiple toasts can animate simultaneously, animation doesn't block user interaction or cause lag</done>
</task>

<task type="auto">
  <name>Task 4: Implement fade-out animation and auto-dismiss timer for non-blocking removal</name>
  <files>src/Control-Patterns-Modern.fx, src/App-OnStart-Minimal.fx</files>
  <action>
Implement two approaches for auto-dismiss based on notification type:

**Approach 1: Pure Power Fx Visibility-Based Fade (Simpler)**

In Control-Patterns-Modern.fx (around line 650), modify cnt_Toast.Visible formula to fade-out before removal:

```
Visible property currently: If(ThisItem.AutoClose && Now() - ThisItem.CreatedAt > TimeValue("0:0:5"), false, true)

Enhanced with fade-out effect:
If(
  ThisItem.AutoClose && Now() - ThisItem.CreatedAt > TimeValue("0:0:4.7"),
  false,  // Hide after 4.7s (fade starts at 4.7s, completes by 5s)
  true
)
```

Then add fade-out via Opacity property (lines 655-670):
```
Opacity property (new):
If(
  ThisItem.AutoClose && Now() - ThisItem.CreatedAt > TimeValue("0:0:4.7"),
  Max(0, 1 - ((Now() - ThisItem.CreatedAt - TimeValue("0:0:4.7")) / TimeValue("0:0:0.3"))),
  1  // Full opacity while visible
)
```

Comment: "Opacity fades from 1 to 0 over last 300ms before Visible becomes false"

**Approach 2: Timer Control-Based Auto-Dismiss (More Precise)**

In App-OnStart-Minimal.fx, add timer initialization (lines 308-320, in Section 7):

```powerfx
// OPTIONAL: Timer for auto-dismiss (if using timer-based approach instead of Power Fx timing)
// Only create this if you implement Approach 2 below
// Set(TimerAutoClose, Blank());  // Will be set by toast container
```

In Control-Patterns-Modern.fx, add timer-based cleanup (lines 675-690):

```
For each toast: If(ThisItem.AutoClose, trigger cleanup at ThisItem.Duration ms)

Option A: Use After() function if available:
Set(ToastToRemove, ThisItem.ID);
After(ThisItem.Duration / 1000, Seconds, RemoveToast(ToastToRemove))

Option B: Use Power Automate flow trigger (advanced; skip for Phase 4):
// Would require Cloud Flow, deferred to future phase
```

**Recommendation:** Use Approach 1 (Power Fx Visibility-Based) for Phase 4:
- Simpler to implement (no additional timer setup)
- No external dependencies (pure formulas)
- Works reliably across Power Apps versions
- Fade-out effect looks polished

Document choice and implementation in comments.

3. Add safety net cleanup (optional, in App-OnStart Section 7):
   Comment: "// OPTIONAL: Periodic cleanup of stuck toasts (safety net if auto-dismiss fails)"
   Could add background flow that runs hourly to clear toasts older than 30 minutes
   Keep commented out unless needed during testing

All auto-dismiss logic must respect AutoClose flag: errors never dismiss automatically (AutoClose=false), info/success/warning do (AutoClose=true).
  </action>
  <verify>
After implementing auto-dismiss:
1. Call NotifySuccess("Success") and watch for 5 seconds
   - Toast should remain visible for ~4.7s
   - Opacity should fade during last 0.3s
   - Toast should disappear by 5s mark
2. Call NotifyError("Error") and wait 6 seconds
   - Toast should remain completely opaque (no fade)
   - Toast should NOT disappear after 5s (requires manual close)
   - X button should work at any time
3. Call multiple notifications (Success, Warning, Info) and verify each auto-dismisses after 5s
4. Verify error toast never auto-dismisses (stays visible indefinitely until X clicked)
5. Open Monitor and check NotificationStack collection:
   - After 5s, auto-close toasts should be removed from collection (or marked as removed)
   - Error toasts should persist in collection until RemoveToast called
  </verify>
  <done>Success/info/warning toasts fade out and disappear after 5 seconds automatically, error toasts remain indefinitely until user clicks X, all auto-dismiss respects AutoClose flag, no startup time regression</done>
</task>

<task type="auto">
  <name>Task 5: Test toast stacking, z-index, and interactive behavior with multiple simultaneous notifications</name>
  <files>src/Control-Patterns-Modern.fx</files>
  <action>
Create comprehensive test scenarios to verify notification system behavior under load:

**Test Scenario 1: Basic Stacking**
1. In a formula bar or test button, execute:
   ```
   NotifySuccess("Message 1");
   NotifySuccess("Message 2");
   NotifySuccess("Message 3")
   ```
2. Observe: All 3 toasts visible in top-right, stacked vertically
3. Verify: Newest (Message 3) appears on top; oldest (Message 1) on bottom
4. Verify: No overlap between toasts (proper Spacing: 12 between them)
5. Expected timing: All three appear almost simultaneously

**Test Scenario 2: Mixed Types**
1. Execute:
   ```
   NotifyInfo("Info message");
   NotifyWarning("Warning message");
   NotifyError("Error message");
   NotifySuccess("Success message")
   ```
2. Observe: All 4 toasts visible with different colors (blue, amber, red, green)
3. Verify: Icons appear correctly (info=ℹ, warning=⚠, error=✕, success=✓)
4. Verify: Colors match GetToastBackground() UDF logic
5. Expected: All visible simultaneously; Info/Success fade after 5s; Warning fades after 5s; Error persists

**Test Scenario 3: Rapid Sequential Notifications**
1. Loop: Repeat NotifySuccess("Toast N") 10 times in rapid succession
2. Observe: Each toast added to collection without losing previous ones
3. Verify: All 10 toasts visible in stack (may require scrolling in container)
4. Verify: NotificationCounter increments to 10 (all unique IDs)
5. Expected: No crashes, no duplicate messages, all toasts rendered

**Test Scenario 4: Manual Dismissal**
1. Call NotifyError("Error 1") and NotifyError("Error 2")
2. Click X button on Error 1 (top toast)
3. Verify: Error 1 disappears; Error 2 still visible
4. Verify: Clicking Error 1's button didn't affect Error 2
5. Click X on Error 2
6. Verify: Both toasts gone; container empty/hidden

**Test Scenario 5: Auto-Dismiss vs Manual**
1. Call NotifySuccess("Will auto-close") and NotifyError("Requires close")
2. Wait 4 seconds
3. Verify: Success toast still visible (not yet dismissed)
4. Wait 2 more seconds (now at 6s total)
5. Verify: Success toast is gone; Error toast still present
6. Click X on Error
7. Verify: Both toasts gone

**Test Scenario 6: Z-Index and Non-Blocking Behavior**
1. Create test gallery or form with interactive controls
2. Call NotifySuccess("Click me while toast visible")
3. While toast is visible, try to:
   - Click gallery item → should select item (toast doesn't block)
   - Click form field → should focus field (toast doesn't block)
   - Click button → should activate button (toast doesn't block)
4. Verify: All interactions work; toast doesn't intercept clicks
5. Verify: Toast X button still works (overlays don't prevent close button)

**Test Scenario 7: Performance Under Load**
1. Execute loop: ForAll(Sequence(50), NotifySuccess("Notification " & Value))
2. Open Monitor tool and watch performance metrics
3. Verify: No significant lag in UI (FPS remains smooth)
4. Verify: Toast rendering doesn't cause app slowdown
5. Verify: NotificationStack collection has 50 rows
6. Wait for auto-dismiss: All 50 toasts should fade and disappear over 5s
7. Verify: App remains responsive during auto-dismiss cleanup

**Test Scenario 8: Long Message Text**
1. Call NotifyWarning("This is a very long warning message that will definitely wrap across multiple lines in the toast container to test text wrapping behavior and ensure the toast grows in height appropriately")
2. Verify: Text wraps within 350px width
3. Verify: Toast height grows to accommodate message
4. Verify: Icon and close button remain aligned (not broken by text wrapping)
5. Verify: Toast still visible and dismissible

Document test results in SUMMARY.md. Record any failures and resolutions.
  </action>
  <verify>
After running all test scenarios:
1. Review Monitor logs: No errors during any test
2. Review NotificationStack collection after tests: Should be empty (all auto-dismissed or manually closed)
3. Review app performance metrics: No significant degradation
4. All 8 test scenarios should pass without failures
5. Document any workarounds or limitations discovered
  </verify>
  <done>Toast stacking verified without overlap, z-index confirmed non-blocking, auto-dismiss timers working per type, manual dismissal working correctly, performance acceptable under load (50+ toasts), mixed notification types render correctly, long text wraps properly</done>
</task>

## Verification

After all tasks complete, verify:

1. **Toast container exists:** Tree view shows cnt_NotificationStack in main screen
2. **Toast appears in top-right:** Call NotifySuccess("test"), toast appears at (Parent.Width - 400, 16)
3. **Multiple toasts stack:** Call 3 notifications, all visible and properly spaced
4. **Colors per type:** Success=green, Error=red, Warning=amber, Info=blue (per ThemeColors)
5. **Icons appear:** ✓, ✕, ⚠, ℹ for respective types
6. **Auto-dismiss works:** Success/info/warning gone after 5s, errors persist indefinitely
7. **Close button works:** X button removes specific toast without affecting others
8. **Non-blocking:** Can interact with app while toast visible
9. **Animations smooth:** Slide-in entrance, fade-out exit (no jank)
10. **Z-index correct:** Toast on top layer, doesn't appear behind other content

## Success Criteria

1. Toast notifications render in top-right corner with proper Fluent Design styling
2. Multiple simultaneous toasts stack vertically without overlap or content shift
3. Each toast displays correct background color, icon, and message text per notification type
4. Auto-dismiss works correctly: info/success/warning disappear after 5s, errors require manual close
5. Close button (X) removes individual toast immediately
6. Toast animations are smooth and non-blocking (don't prevent user interaction)
7. App remains responsive with 50+ simultaneous toasts (performance acceptable)
8. All accessibility labels properly configured for screen readers

## Output

After completion, create `.planning/phases/04-user-experience-documentation/04-02-SUMMARY.md` with:
- Complete cnt_NotificationStack container formula documentation
- Complete cnt_Toast tile control formula documentation
- Screenshots or descriptions of toast appearance in Success/Error/Warning/Info states
- Test results from all 8 test scenarios
- Performance metrics (FPS, render time, collection size under load)
- Animation timing specifications and implementation approach chosen
- Any deviations from initial design and rationale
- Recommendations for future improvements (action buttons, sound, animations)
